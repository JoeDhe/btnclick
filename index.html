<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PWA Install Events</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <!-- pwa manifest -->
    <link rel="manifest" href="./manif.json" />
    <!-- Older android support -->
    <meta name="theme-color" content="#bada55" />
    <!-- ios support -->
    <link rel="apple-touch-icon" href="https://drive.google.com/uc?export=view&id=1bYFWFEiksjv1IvaCjYI8U3GQt-cPov_T" />
    <meta name="apple-mobile-web-app-status-bar" content="#bada55" />
  </head>
  <body>
    <div class="container p-3 justify-content-center vh-100">
    <header>
      <h1>PWA Install Events</h1>
    </header>
    
      <p>
        Important to note, on iOS, all browsers are forced to use the Safari
        Webkit JavaScript Engine. This means that Firefox and Chrome lose some
        of their capabilities when running on an iOS device.
      </p>
      <p>
        <button type="button" class="btn btn-lg btn-outline-primary" id="installBtn">INSTALL APP</button>
      </p>
    </div>
    <script>
     if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
               console.log('SW registered');
      }

      let prompt;
      window.addEventListener('beforeinstallprompt', function(e){
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Stash the event so it can be triggered later.
        prompt = e;
      });
      
      let installButton = document.getElementById("installBtn");
      installButton.addEventListener('click', function(){
         prompt.prompt();
      })
      
      let installed = false;
      installButton.addEventListener('click', async function(){
        prompt.prompt();
        let result = await that.prompt.userChoice;
        if (result&&result.outcome === 'accepted') {
           installed = true;
        }
      })
      
      window.addEventListener('appinstalled', async function(e) {
        installButton.style.display = "none";
      });
      
      let installable = true;
        if (!('serviceWorker' in navigator)){
          installable = false;
        }
      
      //check when the page is loaded if it matches one of the PWA display modes
        window.addEventListener('DOMContentLoaded', function(){
           if (navigator.standalone || window.matchMedia('(display-mode: standalone)').matches || window.matchMedia('(display-mode: fullscreen)').matches || window.matchMedia('(display-mode: minimal-ui)').matches) {
             installed = true;
            }
        });

        //but also add a listener. After app installation on desktop, the app will open in their own window right away.
        window.addEventListener('DOMContentLoaded', function(){
           window.matchMedia('(display-mode: standalone)').addListener(function(e){
             if (e.matches) { installed = true;}
           });
           window.matchMedia('(display-mode: fullscreen)').addListener(function(e){
             if (e.matches) { installed = true;}
           });
           window.matchMedia('(display-mode: minimal-ui)').addListener(function(e){
             if (e.matches) { installed = true; }
           });
         });
      
          window.addEventListener('appinstalled', function(){
            document.cookie = "appinstalled=true;expires=Tue, 30 Mar 2023 23:59:59 GMT;path=/";
          })

          window.addEventListener('beforeinstallprompt', function(){
            document.cookie = "appinstalled=false;expires=Tue, 30 Mar 2023 23:59:59 GMT;path=/";
          })
      
               if ('getInstalledRelatedApps' in window.navigator) {
               let relatedApps = await window.navigator.getInstalledRelatedApps();
               if (relatedApps.length > 0){
                  installed = true;
               }
               else {
                 installed = false;
               }
            }
      
            //a somewhat verbose approach to iOS detection
            function isThisDeviceRunningiOS(){
              if (['iPad Simulator', 'iPhone Simulator','iPod Simulator', 'iPad','iPhone','iPod'].includes(navigator.platform))
               return true;
              }
              // iPad on iOS 13  
              else if (navigator.userAgent.includes("Mac") && "ontouchend" in document)){
                return true;
              }   
              else {
                return false;
              }
            }
                       
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  </body>
</html>
